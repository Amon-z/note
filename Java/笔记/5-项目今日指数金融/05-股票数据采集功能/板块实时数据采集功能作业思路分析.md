# 板块实时数据采集功能

接口

```
https://vip.stock.finance.sina.com.cn/q/view/newSinaHy.php
```

拉取的数据格式如下：

```json
var S_Finance_bankuai_sinaindustry = {
"new_blhy":"new_blhy,玻璃行业,19,19.293684210526,-0.17052631578947,-0.87610188740468,315756250,5258253314,sh600586,3.464,9.260,0.310,金晶科技",
"new_cbzz":"new_cbzz,船舶制造,8,12.15875,0.0125,0.10291242152928,214866817,2282104956,sh600150,0.978,24.790,0.240,中国船舶",
  //........省略.......
}
```

- 思路
  - 直接使用=正则切割，就可获取一个标准的json格式数据；
  - 调用json的工具类（jackson gson fastson等）将json的数据转化成Map对象；
  - 获取map中的value值，逐个切割解析，然后封装成板块数据，然后批量插入到数据库下；


各个参数的语义如下：

~~~json
数据格式：
"new_blhy,玻璃行业,19,19.293684210526,-0.17052631578947,-0.87610188740468,315756250,5258253314,sh600586,3.464,9.260,0.310,金晶科技"
参数语义：
['0.板块编码',1.'板块名称',2.'公司家数',3.'平均价格',4.'涨跌额',5.'涨跌幅',6.'总成交量',7.'总成交金额',8.'领涨股代码',9.'涨跌幅',10.'当前价',11.'涨跌额',12.'领涨股名称']
~~~

`StockTimerTaskService.java`接口创建getStockBlockInfo方法

```java
    /**
     * 获取股票板块实时数据信息
     */
    void getStockBlockInfo();
```

`StockTimerTaskServiceImpl.java`接口实现类写方法具体实现。

```java
@Override
    public void getStockBlockInfo() {
        //1.通过接口获取数据
        String url = "https://vip.stock.finance.sina.com.cn/q/view/newSinaHy.php";
        //2.调用restTemplate采集数据
        //2.1 组装请求头
        HttpHeaders headers = new HttpHeaders();
        //必须填写，否则数据采集不到
        headers.add("Referer","https://finance.sina.com.cn/stock/");
        headers.add("User-Agent","Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36");
        //2.2组装请求对象
        HttpEntity<Object> entity = new HttpEntity<>(headers);
        //2.3restTemplate发起请求
        String info = restTemplate.postForObject(url, entity, String.class);
        log.info("获取数据成功");
        log.info(info);
        //3.获取cur_time
        Date curTime = DateTimeUtil.getLastDate4Stock(DateTime.now()).toDate();
        //4.解析数据，封装到对象并批量插入
        //4.1正则表达式，匹配等号后面的内容
        String regex = "=(.*)";
        Pattern pattern = Pattern.compile(regex);
        Matcher matcher = pattern.matcher(info);
        if(!matcher.find()) {
            return;
        }
        String mapJson = matcher.group(1);
        //创建list数据用于存储对象
        List<StockBlockRtInfo> sInfos = new ArrayList<StockBlockRtInfo>();
        try {
            //4.2使用jackson将json字符串转为map对象
            ObjectMapper mapper = new ObjectMapper();
            Map<String, String> map = mapper.readValue(mapJson, new TypeReference<Map<String,String>>(){});
            //4.3遍历map对象的的值，每个值为一条股票板块信息
            for(String value : map.values()) {
                //4.4按逗号分割股票板块信息并存入数组
                String[] s = value.split(",");
                //4.5从数组中取出属性对应的值封装成股票板块信息对象
                StockBlockRtInfo sInfo = StockBlockRtInfo.builder()
                        .id(idWorker.nextId())
                        .label(s[0])
                        .blockName(s[1])
                        .companyNum(Integer.valueOf(s[2]))
                        .avgPrice(new BigDecimal(s[3]))
                        .updownRate(new BigDecimal(s[5]))
                        .tradeAmount(Long.parseLong(s[6]))
                        .tradeVolume(new BigDecimal(s[7]))
                        .curTime(curTime)
                        .build();
                //将对象存入数组
                sInfos.add(sInfo);
            }
            //批量插入数据
            stockBlockRtInfoMapper.insertBatch(sInfos);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
```

`StockBlockRtInfoMapper.java`添加接口

```java
    //批量插入股票板块数据
    void insertBatch(@Param("sInfos") List<StockBlockRtInfo> sInfos);
```

`StockBlockRtInfoMapper.xml`添加sql语句

```java
    <insert id="insertBatch">
        INSERT INTO stock_block_rt_info
        ( id, label, block_name, company_num, avg_price, updown_rate,
         trade_amount, trade_volume, cur_time )
        VALUES
        <foreach collection="sInfos" item="si" separator=",">
            (#{si.id,jdbcType=BIGINT},#{si.label,jdbcType=CHAR},#{si.blockName,jdbcType=CHAR}
            ,#{si.companyNum,jdbcType=INTEGER},#{si.avgPrice,jdbcType=DECIMAL},#{si.updownRate,jdbcType=DECIMAL}
            ,#{si.tradeAmount,jdbcType=BIGINT},#{si.tradeVolume,jdbcType=DECIMAL},#{si.curTime,jdbcType=TIMESTAMP})
        </foreach>
    </insert>
```





















